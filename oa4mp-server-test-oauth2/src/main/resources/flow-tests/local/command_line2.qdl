#! /usr/bin/env -S qdl-run

/* Next should be set in the main.qdl script.*/
script_path('/home/ncsa/dev/ncsa-git/oa4mp/oa4mp-server-test-oauth2/src/main/resources/flow-tests' ~ script_path());

cfg.'id'  := 'localhost:command.line2';
cfg.'idp'  := 'ANY';
cfg.'file' := '/home/ncsa/dev/csd/config/client-oa2.xml';
cfg.'flow_type' := 'df';
cfg.'description' :=  'This tests code challenge machinery, AT permissions, device flow and exchanges.';
params.'authz' :=  {
                    'scope': 'read: write: x.y',
          'code_challenge' : 'N_zjM2czxZIWNar-lWUiuS7-Pacwh-k-L_Akpje6AmY',
   'code_challenge_method' : 'S256'
   };
params.'token' := {
  'code_verifier' : 'qBdfP8Wmpomgkq6aJwcvZQMHx553RK4P7LAYxmzMAkmo8cM7MlE8ViJSOx38nlHr',
          'scope' : 'read: write: x.y'
   };
params.'exchange':={'scope':'read:/home/jeff write:/data/jeff/cluster x.y:/abc/def/ghi'};
rc := script_load('driver.qdl', cfg., params.);
⊨ rc == 0: (rc==-1?'user aborted':'there was an error initiating the flow');
access. := clc#access();
claims. := claims();

user := claims.'sub';
expected_scopes. :=['read:/home/'+user,'write:/data/'+user+'/cluster', 'x.y:/abc/def'];

ss. := tokenize(access.'access_token'.'jwt'.'scope', ' ');

⊨ is_defined(access.'access_token'.'jwt'.'wlcg.ver'): 'error, this is not a WLCG access token';
⊨ access.'access_token'.'lifetime' == 900000 : 'wrong lifetime, expected 900000, got ' + (access.'access_token'.'lifetime');
⊨ user == access.'access_token'.'jwt'.'sub' : 'subject in id and access token do not match';
⊨ reduce(@&&, ss.∈ expected_scopes.) :  'incorrect access scopes';

refresh();
expected_scopes. :=['read:/home/'+user,'write:/data/'+user+'/cluster', 'x.y:/abc/def/ghi'];
⊨ access.'access_token'.'lifetime' == 900000 : 'wrong lifetime, expected 900000, got ' + (access.'access_token'.'lifetime');
⊨ user == access.'access_token'.'jwt'.'sub' : 'subject in id and access token do not match';
⊨ reduce(@&&, ss.∈ expected_scopes.) :  'incorrect access scopes';

exchange();
⊨ access.'access_token'.'lifetime' == 900000 : 'wrong lifetime, expected 900000, got ' + (access.'access_token'.'lifetime');
⊨ user == access.'access_token'.'jwt'.'sub' : 'subject in id and access token do not match';
⊨ reduce(@&&, ss.∈ expected_scopes.) :  'incorrect access scopes';

say('ok!');
/*
{"iss":"http://localhost:9443/custom/issuer","aud":"https://localhost/fermilab","exp":1666909292,"nbf":1666908387,"iat":1666908392,
"wlcg.ver":"1.0","jti":"https://localhost:9443/oauth2/3aa6b2b19b78489f67a0a1dc6ceba860?type=accessToken&ts=1666908391833&version=v2.0&lifetime=900000",
"scope":"read:/home/http://cilogon.org/serverT/users/21340363 write:/data/http://cilogon.org/serverT/users/21340363/cluster",
"sub":"http://cilogon.org/serverT/users/21340363"}
*/

